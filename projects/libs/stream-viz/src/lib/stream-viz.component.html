<div class="sidebar">
  <div class="sidebar-section">
    <div class="sidebar-header">Operators</div>
    <div class="operator-box">
      @for (operator of streamVizService.operators(); track operator.name) {
        <div
          class="operator"
          style="width: 105px; height: 30px; position: relative"
          (mousedown)="addOperator(operator, $event)"
        >
          {{ operator.name }}
        </div>
      }
    </div>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-header">Emitter</div>

    @for (emitterDescription of streamVizService.emitters(); track emitterDescription) {
      <div class="emitter-button" (click)="addEmitterFromDescription(emitterDescription)">
        {{ emitterDescription.name }}
      </div>
    }
  </div>

  <div class="sidebar-section">
    <div class="sidebar-header">Other</div>

    <div style="width: 100%; display: flex; gap: 5px">
      <div (click)="addTap()" class="emitter-button" style="padding-left: 10px; padding-right: 10px">Tap</div>
      <div (click)="addCounter()" class="emitter-button" style="padding-left: 10px; padding-right: 10px">Counter</div>
    </div>
  </div>


  <ng-content select="[sidebar-item]"></ng-content>


  <div style="width: 100%; display: flex; justify-content: space-around">
    <p-button severity="secondary" (click)="saveAsVisible = true" label="Save" />
    <p-button severity="secondary" (click)="restoreVisible = true" label="Restore" />
    <p-button severity="secondary" (click)="reset()" label="Reset" />
  </div>
</div>

<as-split direction="vertical">
  <div *asSplitGutter="let isDragged = isDragged" class="custom-shade-gutter" [class.dragged]="isDragged">
    <div class="custom-shade-gutter-icon"></div>
  </div>
  <as-split-area [size]="100">
    <div #stage style="display: flex; position: relative">
      <connections [showStartMarker]="true" [connections]="noneTargetConnections()"></connections>

      <div style="position: absolute; left: 0; top: 0" #pixi></div>

      @for (emitter of emitters(); track emitter.id) {
        @if (emitter.isStartEmitter) {
          <div
            (contextmenu)="onEmitterContextMenu($event, emitter)"
            [style.transform]="'translate(' + emitter.x() + 'px,' + emitter.y() + 'px)'"
            [style.width]="emitter.width + 'px'"
            style="color: #fff"
            class="emitter start"
            (click)="emitter.activate()"
          >
            <div class="type">
              {{ emitter.type }}
            </div>
            <div class="color-indicator" [style.background]="emitter.color"></div>
          </div>
        } @else {
          <div
            (contextmenu)="onEmitterContextMenu($event, emitter)"
            [style.transform]="'translate(' + emitter.x() + 'px,' + emitter.y() + 'px)'"
            [style.background]="emitter.color"
            [style.width]="emitter.width + 'px'"
            style="color: #fff"
            class="emitter"
            (click)="emitter.activate()"
          >
            @if (emitter.isStartEmitter) {
              {{ emitter.type }}
            }
            <!-- {{ emitter.hot() }} -->
            @if (emitter.type === "interval") {
              <input
                [(ngModel)]="emitter.property1"
                style="field-sizing: content; background: transparent; border: none"
              />
            }
          </div>
        }
      }

      <div style="position: relative">
        @for (counter of counters(); track counter.id) {
          <div
            [draggable]
            [positioning]="'none'"
            (heightUpdated)="counter.setHeight($event)"
            (widthUpdated)="counter.setWidth($event)"
            (positionUpdated)="counter.setPos($event)"
            class="counter"
            [style.width]="counter.width() + 'px'"
            [style.height]="counter.height() + 'px'"
            [style.transform]="'translate(' + counter.x() + 'px,' + counter.y() + 'px)'"
          >
            {{ counter.count() }}
            <!-- x: {{ counter.x() }} y: {{ counter.y() }} -->
          </div>
        }

        @for (tap of taps(); track tap.id) {
          <div
            (click)="selectTap(tap)"
            [draggable]
            [positioning]="'none'"
            (heightUpdated)="tap.setHeight($event)"
            (widthUpdated)="tap.setWidth($event)"
            (positionUpdated)="tap.setPos($event)"
            class="counter"
            [style.width]="tap.width() + 'px'"
            [style.height]="tap.height() + 'px'"
            [style.transform]="'translate(' + tap.x() + 'px,' + tap.y() + 'px)'"
          >
            {{ tap.count() }}
            <!-- x: {{ counter.x() }} y: {{ counter.y() }} -->
          </div>
        }

        @for (operator of operators(); track operator.id) {
          <operator
            [operator]="operator"
            (click)="selectOperator(operator)"
            (contextmenu)="onObstacleContextMenu($event, operator)"
          ></operator>
        }

        <connections [connections]="targetConnections()"></connections>
      </div>
    </div>
  </as-split-area>
  <as-split-area [size]="0">
    <div style="height: 100%; width: 100%; background: var(--sidebar-bg); display: flex; color: #fff">
      @if (selectedOperator) {
        @if (selectedOperator.type === "throttle") {
          <div style="width: 300px">
            <div>Throttle Options</div>

            <input [(ngModel)]="selectedOperator.height" (ngModelChange)="updateOperatorInputs()" />
          </div>
        } @else if (selectedOperator.type === "filter" || selectedOperator.type === "map") {
          <div class="option-box" style="width: 500px">
            <div class="header">Filter function</div>
            <ng-monaco
              style="width: 500px"
              [declarations]="selectedOperatorDataType"
              [code]="selectedOperator.value1"
              (codeChanged)="selectedOperator.value1 = $event"
            ></ng-monaco>
          </div>
        } @else {
          <div class="option-box" style="width: 300px">
            <div class="header">Operator Options</div>
            <div style="padding: 5px">
              <input type="text" [(ngModel)]="selectedOperator.value1" />
            </div>
          </div>
        }
      }

      @if (selectedTap) {
        <div class="option-box" style="min-width: 200px">
          <div class="header">Selected Tap</div>
          <div>
            {{ selectedTap.currentItem()?.value | json }}
          </div>
        </div>
      }

      <div class="option-box">
        <div class="header">Code</div>
        <div style="padding: 5px">
          <pre style="color: #dedede">

        {{ generatedCode }}
      </pre
          >
        </div>
      </div>
    </div>
  </as-split-area>
</as-split>

<p-contextMenu #contextMenu appendTo="body" />

<p-dialog header="Save Stream" [modal]="true" [(visible)]="saveAsVisible" [style]="{ width: '25rem' }">
  <div class="flex align-items-center gap-3 mb-3">
    <label for="username" class="font-semibold w-6rem">Sabe As</label>
    <input #saveAsName pInputText id="username" class="flex-auto" autocomplete="off" />
  </div>
  <div class="flex justify-content-end gap-2">
    <p-button label="Cancel" severity="secondary" (onClick)="saveAsVisible = false" />
    <p-button label="Save" (onClick)="save(saveAsName.value); saveAsVisible = false" />
  </div>
</p-dialog>

<p-dialog header="Load Stream" [modal]="true" [(visible)]="restoreVisible" [style]="{ width: '25rem' }">
  <div class="flex gap-3 mb-3" style="flex-direction: column">
    @for (s of stored; track s.name) {
      <div (click)="restore(s); restoreVisible = false">
        {{ s.name }}
      </div>
    }
  </div>
  <div class="flex justify-content-end gap-2">
    <p-button label="Cancel" severity="secondary" (onClick)="restoreVisible = false" />
  </div>
</p-dialog>
