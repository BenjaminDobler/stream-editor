<div class="sidebar">
  <div class="sidebar-section">
    <div class="sidebar-header">Operators</div>
    <div class="operator-box">
      @for (operator of streamVizService.operators(); track operator.name) {
        <div
          class="operator"
          style="width: 105px; height: 30px; position: relative"
          (mousedown)="addOperator(operator, $event)"
        >
          {{ operator.name }}
        </div>
      }
    </div>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-header">Emitter</div>

    @for (emitterDescription of streamVizService.emitters(); track emitterDescription) {
      <div class="emitter-button" (click)="addEmitterFromDescription(emitterDescription)">
        {{ emitterDescription.name }}
      </div>
    }
  </div>

  <div>
    <button (click)="addCounter()">Counter</button>
    <button (click)="addTap()">Tap</button>
  </div>

  

  <button (click)="save()">Save</button>
  <button (click)="restore()">Restore</button>
  <button (click)="reset()">Reset</button>
</div>

<as-split direction="vertical">
  <as-split-area [size]="100">
    <div #stage style="display: flex; position: relative">
      <connections [showStartMarker]="true" [connections]="noneTargetConnections()"></connections>

      <div style="position: absolute; left: 0; top: 0" #pixi></div>

      @for (emitter of emitters(); track emitter.id) {
        @if (emitter.isStartEmitter) {
          <div
            (contextmenu)="onEmitterContextMenu($event, emitter)"
            [style.transform]="'translate(' + emitter.x() + 'px,' + emitter.y() + 'px)'"
            [style.width]="emitter.width + 'px'"
            style="color: #fff"
            class="emitter start"
            (click)="emitter.activate()"
          >
            <div class="type">
              {{ emitter.type }}
            </div>
            <div class="color-indicator" [style.background]="emitter.color"></div>
          </div>
        } @else {
          <div
            (contextmenu)="onEmitterContextMenu($event, emitter)"
            [style.transform]="'translate(' + emitter.x() + 'px,' + emitter.y() + 'px)'"
            [style.background]="emitter.color"
            [style.width]="emitter.width + 'px'"
            style="color: #fff"
            class="emitter"
            (click)="emitter.activate()"
          >
            @if (emitter.isStartEmitter) {
              {{ emitter.type }}
            }
            <!-- {{ emitter.hot() }} -->
            @if (emitter.type === "interval") {
              <input
                [(ngModel)]="emitter.property1"
                style="field-sizing: content; background: transparent; border: none"
              />
            }
          </div>
        }
      }

      <div style="position: relative">
        @for (counter of counters(); track counter.id) {
          <div
            [draggable]
            [positioning]="'none'"
            (heightUpdated)="counter.setHeight($event)"
            (widthUpdated)="counter.setWidth($event)"
            (positionUpdated)="counter.setPos($event)"
            class="counter"
            [style.width]="counter.width() + 'px'"
            [style.height]="counter.height() + 'px'"
            [style.transform]="'translate(' + counter.x() + 'px,' + counter.y() + 'px)'"
          >
            {{ counter.count() }}
            <!-- x: {{ counter.x() }} y: {{ counter.y() }} -->
          </div>
        }

        @for (tap of taps(); track tap.id) {
          <div
            (click)="selectTap(tap)"
            [draggable]
            [positioning]="'none'"
            (heightUpdated)="tap.setHeight($event)"
            (widthUpdated)="tap.setWidth($event)"
            (positionUpdated)="tap.setPos($event)"
            class="counter"
            [style.width]="tap.width() + 'px'"
            [style.height]="tap.height() + 'px'"
            [style.transform]="'translate(' + tap.x() + 'px,' + tap.y() + 'px)'"
          >
            {{ tap.count() }}
            <!-- x: {{ counter.x() }} y: {{ counter.y() }} -->
          </div>
        }

        @for (operator of operators(); track operator.id) {
          <operator
            [operator]="operator"
            (click)="selectOperator(operator)"
            (contextmenu)="onObstacleContextMenu($event, operator)"
          ></operator>
        }

        <connections [connections]="targetConnections()"></connections>
      </div>
    </div>
  </as-split-area>
  <as-split-area [size]="0">
    <div style="height: 100%; width: 100%; background: var(--sidebar-bg); display: flex; color: #fff">
      @if (selectedOperator) {
        @if (selectedOperator.type === "throttle") {
          <div style="width: 300px">
            <div>Throttle Options</div>

            <input [(ngModel)]="selectedOperator.height" (ngModelChange)="updateOperatorInputs()" />
          </div>
        } @else if (selectedOperator.type === "filter" || selectedOperator.type === 'map') {
          <div style="width: 300px">
            <div>Filter function</div>
            <ng-monaco
              style="width: 300px"
              [declarations]="selectedOperatorDataType"
              [code]="selectedOperator.value1"
              (codeChanged)="selectedOperator.value1 = $event"
            ></ng-monaco>
          </div>
        } @else {
          <div style="width: 300px">
            <div>Operator Options</div>
            <input type="text" [(ngModel)]="selectedOperator.value1" />
          </div>
        }
      }

      @if (selectedTap) {
        <div style="min-width: 200px">
          <div>Selected Tap</div>
          <div>
            {{ selectedTap.currentItem()?.value | json }}
          </div>
        </div>
      }

      <div>
        <div>Code</div>
        <div>
          <pre style="color: #dedede">

        {{ generatedCode }}
      </pre
          >
        </div>
      </div>
    </div>
  </as-split-area>
</as-split>

<p-contextMenu #contextMenu appendTo="body" />
